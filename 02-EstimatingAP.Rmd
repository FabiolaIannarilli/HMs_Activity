# Estimating activity patterns from camera-trap data {#est}

In this section, we introduce two alternative, model-based approaches to estimate activity patterns from camera-trap data:
 * _trigonometric generalized linear mixed models_ and
 * _cyclic cubic spline generalized linear mixed models_. 

To keep the focus on estimating activity pattern, we encapsulate the code to simulate the data in the function *sim_activity*, that we source after loading the necessary libraries. 

```{r est1, message = FALSE, warnings = FALSE}
# Load libraries and function to simulate activity patterns
library(tidyverse)
library(GLMMadaptive)
library(ggpubr)
library(mgcv)
library(tidyr)
source("source_functions/sim_activity.R")
source("source_functions/sim_to_minute.R")
set.seed(129)

```

We now simulate bimodal activity patterns for 100 sites (M) based on equation 1 reported in section \@ref(var) and the parameters defined in the code below. We set $\tau_i$ and $\gamma_i$ as drawn from the distributions $\tau_i \sim N(0,\sigma_\tau)$ and $\gamma_i \sim N(0,\sigma_\gamma)$, respectively, with $\sigma_\tau = 1$ and $\sigma_\gamma = 0.3$. 

```{r est2}
# Set equations' parameters
M = 100
J = 30
wavelength = 24
n_peak = 2
b0 = -3
b1 = 1 
b2 = 0.7
theta0 = 3
theta1 = 2 
sd_tau = 1
sd_gamma = 0.3
time <- seq(0, wavelength, wavelength/512)

# simulate data
dat <- sim_activity(M = M, 
                     J = J, 
                     wavelength = wavelength, 
                     n_peak = n_peak, 
                     n_sim = 1, 
                     b0 = -3, 
                     b0_constant = TRUE, # common intercept
                     tau_constant = FALSE, 
                     sdtau = sd_tau, # ~site-specific intercept
                     b1 = b1, 
                     b2 = b2, # amplitude of the cosine terms 
                     theta0 = theta0, 
                     theta1 = theta1, # common phaseshifts for the cosine terms
                     phaseshift_constant = FALSE, 
                     sd_phaseshift = sd_gamma, # site-specific phaseshift (equal for both cosine terms)
                     plot_true_act = TRUE)

```

The *sim_activity* function returns a list containing several objects, including the true values of conditional and marginal mean probability of activity used to build the plot above. The list also contains the activity patterns simulated for each of the 100 sites. We can access the information for a randomly selected set of these sites and plot their activity patterns, along with the conditional and marginal mean activity patterns (the red and black curves, respectively, in the following plot). 

```{r est3}
# plot true conditional and marginal with 5 simulated sites
sites_i <- sample(x = 1:M, size = 10, replace = FALSE)
sample_sites <- cbind(sites_i, dat$true_activity_prob[sites_i, 0:25]) 
colnames(sample_sites) <- c("sites", 00:24)
sample_sites <- as.data.frame(sample_sites) %>% 
  pivot_longer(cols = -sites, names_to = "time", values_to = "prob")
  
(pl_sites <- ggplot() +
  geom_line(data = sample_sites, aes(x = as.numeric(time), y = prob, group = sites, color = as.factor(sites)), 
            linewidth = 0.5, alpha = 0.7, linetype = 2) +
  geom_line(data = dat$Conditional, aes(x = time, y = p), linewidth = 1, color = "red", inherit.aes = TRUE) +
  geom_line(data = dat$Marginal, aes(x = time, y = p), linewidth = 1, color = "black", inherit.aes = TRUE) +
  labs(x = "Time of Day", y = "Probability of Activity", title = "C) Var. in frequency of site use and \n time of activity peak", 
       color = "Site_ID")+
  theme_minimal()+
  theme(legend.position = "none",
        legend.title = element_text(size=10,face="bold"),
        legend.text = element_text(size=10,face="bold"),
        #legend.margin=margin(0,0,0,0),
        #legend.box.margin=margin(-5,-10,-10,-10),
        axis.line = element_line(colour = 'black', linetype = 'solid'),
        axis.ticks.x = element_line(colour = 'black', linetype = 'solid'),
        axis.title = element_text(size=8,face="bold"),
        axis.text.y = element_blank(),
        plot.title = element_text(size=9,face="bold"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.text = element_text(size = 9, colour = "black", face = "bold", hjust = 0))+
  geom_segment(aes(x=12, y=min(sample_sites$prob), xend=12, yend=min(sample_sites$prob)-0.05), arrow=arrow(length= unit(0.5, "cm")), 
               linewidth = 1, color = "orange", linejoin = "mitre") +
  geom_segment(aes(x=12, y=0.45+0.003, xend=12, yend=0.45+0.053), arrow=arrow(length= unit(0.5, "cm")), 
               linewidth = 1, color = "orange", linejoin = "mitre") +
  geom_segment(aes(x=12 - 0.75, y=max(sample_sites$prob) + 0.02, xend=12 - 7, yend=max(sample_sites$prob) + 0.02), arrow=arrow(length= unit(0.5, "cm")), 
               linewidth = 1, color = "orange", linejoin = "mitre") +
  geom_segment(aes(x=12 + 0.75, y=max(sample_sites$prob) + 0.02, xend=12 + 7, yend=max(sample_sites$prob) + 0.02), arrow=arrow(length= unit(0.5, "cm")), 
               linewidth = 1, color = "orange", linejoin = "mitre") +
  scale_x_continuous(breaks=seq(0,23,length.out=7), labels=seq(0,24,4)))

```
The plot shows that there is great variability in the frequency of use of the different sites and a relatively smaller variation in timing of peak activity. 

We bring together this plot and the two produced in the previous chapter to create Figure 1 in the main manuscript. 
``` {r ms_fig1}
ggarrange(pl, pl_sites, widths = c(66, 34)) %>%   
ggsave(filename = "ms_figures/Fig1_Site_Variability_in_Activity_bimodal.jpg", device = "jpeg", units = "cm", width = 24, height = 10, dpi = 600)
```

## Data preparation

The first step to analyze these activity patterns is to arrange in a specific format the simulated hourly encounter data (i.e. detection events) virtually collected at each one of the simulated sites during a 30-day sampling period. These encounter data are drawn as a Bernoulli distribution based on the probability of activity simulated at each site and time of day $p_{it}$: 
$$
y_{it} \sim Bernoulli(p_{it})
$$ 
and are stored in one of the object of the list created by the *sim_activity* function. We access the encounter data and store them in an object called *y*, which has a number of rows equal to the number of simulated sites and a number of columns equal to 24 (hours) times the length (in days) of the simulated sampling period (e.g. $24 hour * 30 days = 720 encounter occasions$). We add a column which contain an unique identifier for each site (e.g. *id = A1*) and assigned a name to each column that represent the time occasion (e.g. from 1 to 720), then convert the data in long format using the *id* column as reference.

```{r est4}
# The data
y <- as.data.frame(dat$sim_data)
dim(y)

# summarize aggregated data
y <- data.frame(id=paste("A", seq(1,M,1), sep=""), y=as.data.frame(y))
colnames(y) <- c("id", paste0("S", seq(1, ncol(y)-1, 1), sep=""))

# Format data in long format
y_long <- pivot_longer(data = y, cols = -id, names_to = "time", values_to = "y") %>%
                mutate(time=as.numeric(substr(time,2,10)),
                       id = factor(id))

# create variable to describe time as hour (between 0 and 23)
y_long$hour <- sim_to_minute(y_long$time, group = wavelength)

# show first few rows of the dataset created
knitr::kable(head(y_long))
```

We obtain a dataset in which each row specify the outcome (i.e. encounter or non-encounter of the target species) at a certain site during a specific hour of a certain day of sampling.

To optimize computational time, we can reduce the number of rows in the dataset but counting the number of hourly-long occasions in which the species was observed (i.e. successes) and the number of occasion in which the species was not observed (i.e. failures) for each hourly time interval and camera site.

```{r est5}
# count successes and failures at each site-occasion
occasions_cbind <- y_long %>% 
  group_by(id, hour) %>% 
  summarise(success = sum(y),
            n_events = n(),
            failure = n_events - success) %>% 
  dplyr::rename(Site = id,
               Time = hour)

# show first few rows of the dataset created
knitr::kable(head(occasions_cbind))
```

Each row in this dataset specify how many time a species was (0 times) and was not (30 times) detected at a certain site (A1) during a certain time interval (0, that is from 00:00 to 00:59). We can now use this dataframe to estimate activity patterns using trigonometric Generalized Linear Mixed Models.

## Trigonometric GLMMs

Equation 1 in section \@ref(var) is non linear due the present of the phaseshift parameters. Currently there is no out-of-the-box option in R to code non linear model using a frequentist approach. To overcome this challenge, we rewrite equation 1 using compound angle formula (see also main text):
$$

logit(p_t) = \beta_0 + \alpha_1*cos(\frac{2\pi t}{24}) + \alpha_2*sin(\frac{2\pi t}{24}) + \alpha_3*cos(\frac{2\pi t}{12}) + \alpha_4*sin(\frac{2\pi t}{12}) + \tau_i

$$
where $\alpha_1= \beta_1*cos(\theta_0 + \gamma_i)$, $\alpha_2= -\beta_1*sin(\theta_0 + \gamma_i)$, $\alpha_3= \beta_2*cos(\theta_1 + \gamma_i)$, $\alpha_4= -\beta_2*sin(\theta_1 + \gamma_i)$. 

In this version (labeled as equation 2 in the main text), we can model activity patterns with any packages commonly used to fit GLMMs. Here, we choose the *GLMMadaptive* library \@ref(Rizopoulos2022) because it give us the option to also explore conditional and marginal mean activity patterns (see section \@ref(condvsmarg)).

The simplest trigonometric GLMM we can run is one that includes only a random intercept. In the context of estimating activity patterns, a random intercept-only model accounts for variability in the frequency of use of the sites (i.e. vertical shifts among the curves), but not variability in the timing of peak activity (i.e. horizontal shift).   

```{r est6}
# run model
trig_rand_int <- mixed_model(fixed = cbind(success, failure) ~ 
                      cos(2 * pi * Time/24)  + sin(2 * pi * Time/24) +
                      cos(2 * pi * Time/12)  + sin(2 * pi * Time/12),
                    random = ~  1  |   Site, 
                    data = occasions_cbind, 
                    family = binomial(), 
                    iter_EM = 0)
summary(trig_rand_int)

```
For trigonometric models, interpreting the model results looking at the coefficient estimates could be daunting. An easier and effective way to explore the results is to visually check the activity patterns predicted based on the model itself. Thus, we predict the estimated activity patterns, backtrasform the results in the probability scale, and plot the estimated activity pattern along with the true simulated conditional activity patterns.

```{r est7}
# estimated activity pattern
newdat <- with(occasions_cbind, expand.grid(Time = seq(min(Time), 24, length.out = 48)))
cond_eff0 <- effectPlotData(trig_rand_int, newdat, marginal = FALSE) %>% 
  mutate(pred = plogis(pred),
         low = plogis(low),
         upp = plogis(upp),
         Mod = "Estimated: Random Intercept-only")

# simulated conditional activity pattern
cond_true <- dat$Conditional %>% 
  mutate(low = NA,
         upp = NA,
         Mod = "Simulated Conditional") %>% 
  dplyr::rename(Time = time, pred = p) %>% 
  select(Time, pred, low, upp, Mod)

# combine the two for visualization  purposes
cond_eff <- rbind(cond_true, cond_eff0)

# plot
ggplot(cond_eff, aes(Time, pred)) +
  geom_ribbon(aes(ymin = low, ymax = upp, color = Mod, fill = Mod), alpha = 0.3, linewidth = 0.25) + #
  geom_line(aes(color = Mod), linewidth = 1) + #
  scale_color_manual(values = c("blue", "red")) +
  scale_fill_manual(values = c("blue", "red")) +
  labs(x = "Time of Day (Hour)", y = "Predicted Activity Pattern \n (probability)", title = "Estimated vs Simulated Activity Patterns")+
  theme_minimal()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size=10,face="bold"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-5,-10,-10,-10),
        plot.title = element_text(size=10,face="bold"),
        axis.line = element_line(colour = 'black', linetype = 'solid'),
        axis.ticks = element_line(colour = 'black', linetype = 'solid'),
        axis.title = element_text(size=9,face="bold"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(colour = 'lightgrey', linetype = 'dashed', linewidth=0.5),
        panel.grid.minor.x = element_blank(),
        strip.text = element_text(size = 9, colour = "black", face = "bold", hjust = 0))+
  scale_x_continuous(breaks=seq(0,23,length.out=7), labels=seq(0,24,4))

```

The activity pattern estimated based on a random-only trigonometric GLMM (in blue) resembles very closely the simulated conditional probability (in red). 

In same cases, we can also suspect that site-specific activity patterns present differences in the timing the sites are used the most by our target species. We can explore this hypothesis by adding a random slope to the model. The choice of the structure of the random slope effect is not trivial; we can include only parameters linked to the first cosine term in equation 1 (i.e. first two terms in equation 2), only terms for the second cosine term in equation 2 (i.e. third and forth terms in equation 2) or both. When possible, based on computational time and the information contained in the data, we recommend to include all the terms and allow for the random intercept to vary independently of the random slope. In *GLMMadaptive*, we ensure this independence by using the syntax || when specifying the random effect component of the model. 

```{r est8, cache=TRUE, cache.path="cache/"}
# run model
trig_rand_slope <- mixed_model(fixed = cbind(success, failure) ~ 
                      cos(2 * pi * Time/24)  + sin(2 * pi * Time/24) +
                      cos(2 * pi * Time/12)  + sin(2 * pi * Time/12),
                    random = ~  cos(2 * pi * Time/24)  + sin(2 * pi * Time/24) +
                                  cos(2 * pi * Time/12)  + sin(2 * pi * Time/12)  ||   Site,
                    data = occasions_cbind, 
                    family = binomial(), 
                    iter_EM = 0)

summary(trig_rand_slope)

```

As before, we visually inspect the estimated activity pattern based on this model and compare it with the simulated conditional mean activity pattern.

```{r est9}
# estimated activity pattern
newdat <- with(occasions_cbind, expand.grid(Time = seq(min(Time), 24, length.out = 48)))
cond_eff1 <- effectPlotData(trig_rand_slope, newdat, marginal = FALSE) %>% 
  mutate(pred = plogis(pred),
         low = plogis(low),
         upp = plogis(upp),
         Mod = "Estimated: Random Intercept and Slope")

# simulated conditional activity pattern
cond_true <- dat$Conditional %>% 
  mutate(low = NA,
         upp = NA,
         Mod = "Simulated Conditional") %>% 
  dplyr::rename(Time = time, pred = p) %>% 
  select(Time, pred, low, upp, Mod)

# combine the two for visualization  purposes
cond_eff <- rbind(cond_true, cond_eff1)

# plot
ggplot(cond_eff, aes(Time, pred)) +
  geom_ribbon(aes(ymin = low, ymax = upp, color = Mod, fill = Mod), alpha = 0.3, linewidth = 0.25) + #
  geom_line(aes(color = Mod), linewidth = 1) + #
  scale_color_manual(values = c("blue", "red")) +
  scale_fill_manual(values = c("blue", "red")) +
  labs(x = "Time of Day (Hour)", y = "Predicted Activity Pattern \n (probability)", title = "Estimated vs Simulated Activity Patterns")+
  theme_minimal()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size=10,face="bold"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-5,-10,-10,-10),
        plot.title = element_text(size=10,face="bold"),
        axis.line = element_line(colour = 'black', linetype = 'solid'),
        axis.ticks = element_line(colour = 'black', linetype = 'solid'),
        axis.title = element_text(size=9,face="bold"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(colour = 'lightgrey', linetype = 'dashed', linewidth=0.5),
        panel.grid.minor.x = element_blank(),
        strip.text = element_text(size = 9, colour = "black", face = "bold", hjust = 0))+
  scale_x_continuous(breaks=seq(0,23,length.out=7), labels=seq(0,24,4))

```

The estimated activity curve closely matches the true activity that was used to generate the data. In this case, adding a random slope improved the estimates only marginally. This is generally the case when there is only a low level of variation in the timing of peak activity across sites [@Iannarilli2020]. 

## Cyclic cubic spline GLMMs

In this section, we illustrate how hierarchical cyclic cubic spline GLMMs can be used to explore activity patterns. Generalized Additive Mixed Models (GAMMs), of which cyclic cubic spline GLMMs are a special case, are complex functions that allow analysts to model non-linear relationship. These models are highly flexible - often computationally intensive for large datasets - and can be used to model a wide array of model structures and related hypotheses. This high flexibility can make these models intimidating at first. A complete review of the different proprieties of these models is beyond the scope of this work (but see (@Pederson2019) and @Wood2017). Here, we present a selection of model structures that, in our opinion, are the most useful when addressing the most common ecological questions related to activity patterns.

We fit a hierarchical cyclic cubic spline GLMM using the *bam* function in package *mgcv* [@Wood2017]. We start with a model that resemble a trigonometric random intercept-only model. We use the argument $bs="re"$ in the smooth $s(Site, bs="re")$ to specifies _Site_ as a random intercept. We also have a cyclic cubic smooth for _Time_. As before, we run the model, predict the estimated activity pattern using the *predict.bam* function available in the *mgcv* package (Wood 2017), and visually compare it with the simulated conditional mean activity pattern. 

### SHOULD TIME BE CODED AS FACTOR?

```{r est10}
# run model
cycl_rand_int <- bam(cbind(success, failure) ~ s(Time, bs = "cc", k = wavelength) + 
                                          s(Site, bs="re"), 
                                          family = "binomial", 
                                          data = occasions_cbind, 
                                          knots = list(Time=c(0,23))) 
summary(cycl_rand_int)

# build estimated activity curves
newdat <- with(occasions_cbind, expand.grid(Time = seq(min(Time), max(Time), 1),
                                            Site = "A1")) #Site doesn't matter
temp <- predict.bam(cycl_rand_int, newdata = newdat,  exclude = "s(Site)", se.fit = TRUE, type = "response") 
cycl_pred <- newdat  %>% 
  mutate(pred = temp$fit,
         low = pred - 1.96*temp$se.fit,
         upp = pred + 1.96*temp$se.fit,
         Mod = "Estimated: Random Intercept-only") %>% 
  select(-Site)

# combine true and estimated curves for visualization  purposes
cond_eff <- rbind(cond_true, cycl_pred)

# plot
ggplot(cond_eff, aes(Time, pred)) +
  geom_ribbon(aes(ymin = low, ymax = upp, color = Mod, fill = Mod), alpha = 0.3, linewidth = 0.25) + #
  geom_line(aes(color = Mod), size = 1) + #
  scale_color_manual(values = c("blue", "red")) +
  scale_fill_manual(values = c("blue", "red")) +
  labs(x = "Time of Day (Hour)", y = "Predicted Activity Pattern \n (probability)", title = "Estimated vs Simulated Activity Patterns")+
  theme_minimal()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size=10,face="bold"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-5,-10,-10,-10),
        plot.title = element_text(size=10,face="bold"),
        axis.line = element_line(colour = 'black', linetype = 'solid'),
        axis.ticks = element_line(colour = 'black', linetype = 'solid'),
        axis.title = element_text(size=9,face="bold"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(colour = 'lightgrey', linetype = 'dashed', linewidth=0.5),
        panel.grid.minor.x = element_blank(),
        strip.text = element_text(size = 9, colour = "black", face = "bold", hjust = 0))+
  scale_x_continuous(breaks=seq(0,23,length.out=7), labels=seq(0,24,4))
  
```

This model corresponds, in general terms, to the trigonometric random intercept-only model we ran earlier and similarly accommodate only for variability in the frequency of site use. The model captures the general shape of the simulated activity curves, but the mean activity estimated for the first peak is quite low compared to the simulated pattern. 

We can add complexity to this model and include a random slope component that allows the site-specific estimates to vary also in the timing of peak activity. In *mgcv*, there is no need to explicitly force the independence between the random intercept and the random slope (as done before for the trigonometric-based model) because there is no covariance term between two random effects.

```{r est11, cache=TRUE, cache.path="cache/"}

# Fit model with general smoother for Time
cycl_rand_slope <- bam(cbind(success, failure) ~ 
                   s(Time, bs = "cc", k = 12) + # general smoother
                   s(Time, bs = "cc", k = 12, by = Site, m = 1) +
                   s(Site, bs="re"), 
                 knots = list(Time=c(0,23)),
                 family = "binomial", 
                 data = occasions_cbind)
# summary(cycl_rand_slope)

# build the estimated activity patterns
newdat <- with(occasions_cbind, expand.grid(Time = seq(min(Time), max(Time), 1),
                                            Site = "A1")) #Site doesn't matter
temp <- predict.bam(cycl_rand_slope, newdata = newdat,  exclude = "s(Site)", se.fit = TRUE, type = "response") 
cycl_pred <- newdat  %>% 
  mutate(pred = temp$fit,
         low = pred - 1.96*temp$se.fit,
         upp = pred + 1.96*temp$se.fit,
         Mod = "Estimated: Random Slope") %>% 
  select(-Site)

# combine the true and estimated curves for visualization  purposes
cond_eff <- rbind(cond_true, cycl_pred)

# plot
ggplot(cond_eff, aes(Time, pred)) +
  geom_ribbon(aes(ymin = low, ymax = upp, color = Mod, fill = Mod), alpha = 0.3, linewidth = 0.25) + #
  geom_line(aes(color = Mod), size = 1) + #
  scale_color_manual(values = c("blue", "red")) +
  scale_fill_manual(values = c("blue", "red")) +
  labs(x = "Time of Day (Hour)", y = "Predicted Activity Pattern \n (probability)", title = "Estimated vs Simulated Activity Patterns")+
  theme_minimal()+
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size=10,face="bold"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-5,-10,-10,-10),
        plot.title = element_text(size=10,face="bold"),
        axis.line = element_line(colour = 'black', linetype = 'solid'),
        axis.ticks = element_line(colour = 'black', linetype = 'solid'),
        axis.title = element_text(size=9,face="bold"),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(colour = 'lightgrey', linetype = 'dashed', linewidth=0.5),
        panel.grid.minor.x = element_blank(),
        strip.text = element_text(size = 9, colour = "black", face = "bold", hjust = 0))+
  scale_x_continuous(breaks=seq(0,23,length.out=7), labels=seq(0,24,4))
  
```

Adding a component that allows for variability in timing of peak activity seems to improve the model fit and provide an estimated activity pattern that more closely resembles the one used to simulated the data. 











