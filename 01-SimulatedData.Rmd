# Variability in activity patterns from camera-trap data {#var}

To illustrate how site-to-site variability can affect the estimate of activity patterns from
camera-trap data, we simulated data under equation 1 explained in the main text and reported here:

$$
y_{it} \sim Bernoulli(p_{it})
$$

$$
logit(p_{it}) = \beta_0 + \beta_1*cos(\frac{2\pi t}{24} + (\theta_0 + \gamma_i)) + \beta_2*cos(\frac{2\pi t}{12} + (\theta_1 + \gamma_i)) + \tau_i
$$

$$
\tau_i \sim N(0,\sigma_\tau)
$$

$$
\gamma_i \sim N(0,\sigma_\gamma)
$$

We load the necessary libraries and set the intercept $\beta_0$, and the two amplitudes $\beta_1$ and $\beta_2$ equal to -3, 1, and 0.7, respectively. We assign the values 3 and 2 to the common phaseshifts terms, $\theta_0$ and $\theta_1$, respectively. 

```{r sim1}
#' Load libraries and set equations' parameters
library(tidyverse)
library(grid)
library(gridExtra)
wavelength = 24
b0 = -3
b1 = 1 
b2 = 0.7
theta0 = 3
theta1 = 2 
tau_i = gamma_i = seq(-1.5, 1.5, by = 0.5)
time <- seq(0, wavelength, wavelength/512)
```
To create examples of *variability in frequency of site-use*, we keep all the parameters constant (with $\gamma_i = 0$) except for $\tau_i$, which varies from -1.5 to 1.5 in increments of 0.5. For illustrative purposes, we assigned these predefined values $\tau_i$, instead of drawing random values from the distribution $N(0,\sigma_\tau)$. We create the curves in logit scale but trasform them in the 
probability scale, for easiness in interpretation. We also include code to calculate conditional and marginal mean activity curves (red and black curves in the following plots); we will cover this aspect in detail in section \@ref(condvsmarg). Here, we only say that the conditional mean curve describes the activity pattern at a typical site, whereas the marginal mean curve describes the activity patterns averaged across all the sites.  

```{r sim2}
# creating the curves
p_df <- data.frame(p = c(
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[1]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[2]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[3]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[5]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[6]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[7])
), time = rep(time, 7), 
mean = c(rep(rep("off", length(time)),3), rep("on", length(time)), rep(rep("off", length(time)),3)),
curvesID = as.factor(rep(1:7, each = length(time))),
curvesLeg = as.factor(rep(c("+/- 1.5 SD", "+/- 1 SD", "+/- 0.5 SD", "Conditional", "+/- 0.5 SD", "+/- 1 SD", "+/- 1.5 SD"), each = length(time)))
)

# calculate marginal mean activity curve
p_df2 <- p_df %>% select(p, time) %>% group_by(time) %>% 
  summarize(p = mean(p)) %>% 
  mutate(mean = "on", curvesID = as.factor(8),
         curvesLeg = as.factor("Marginal"))

p_df <- rbind(p_df, as.data.frame(p_df2))

pl_vert <- ggplot(p_df, aes(x = time, y = p, group = curvesID)) +
  geom_line(aes(color = curvesLeg, size = mean, linetype = mean)) +
  scale_color_manual(values = c("grey40", "grey60", "grey80", "red", "black")) +
  scale_size_manual(values = c(0.5, 1.5)) +
  scale_linetype_manual(values = c(2, 1, 2)) +
  coord_cartesian(ylim = c(-0.05, 0.40)) +
  #geom_path(data = data.frame(x = c(11.5, 9), y = c(0.005, 0.005)), aes(x = x, y = y), linejoin = "mitre") +
  labs(x = "Time of Day", y = "Activity Patterns", title = "A) Variability in frequency of site-use") +
  theme_minimal()+
  theme(legend.position = "none",
        axis.line = element_line(colour = 'black', linetype = 'solid'),
        axis.ticks.x = element_line(colour = 'black', linetype = 'solid'), #element_blank(), #
        axis.text.y = element_blank(), #element_text(size=8),
        axis.title=element_text(size=10,face="bold"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) + 
  geom_segment(aes(x=12, y=min(p), xend=12, yend=min(p)-0.05), arrow=arrow(length= unit(0.5, "cm")), 
               size = 1, color = "orange", linejoin = "mitre") +
  geom_segment(aes(x=12, y=0.25+0.003, xend=12, yend=0.25+0.053), arrow=arrow(length= unit(0.5, "cm")), 
               size = 1, color = "orange", linejoin = "mitre")+
  scale_x_continuous(breaks=seq(0,24,length.out=7), labels=seq(0,24,4)) 
pl_vert
```

In this first plot, the dashed grey curves represents the curves generated using the different values (darker to lighter colors from lower to higher in absolute values) assigned to $\tau_i$. All other things equal, these different values of $\tau_i$ lead to a vertical shift in the activity curves, which corresponds to a change in the frequency of site-use. 

To create examples of *variability in timing of activity peak*, we set the random phaseshift $\gamma_i$ as equal to 0, $\pm$ 0.5, $\pm$ 1.0, and $\pm$ 1.5, while keeping $\tau_i = 0$ and all the other parameters constant. As the final step for this example, we joint the two plots to created Figure 1, reported in the main text. 

```{r sim3}
# creating the curves
p_df <- data.frame(p = c(
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[1]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[1]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[2]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[2]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[3]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[3]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[4]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[5]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[5]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[6]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[6]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[7]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[7]) + tau_i[4])
), time = rep(time, 7), 
mean = c(rep(rep("off", length(time)),3), rep("on", length(time)), rep(rep("off", length(time)),3)),
curvesID = as.factor(rep(1:7, each = length(time))),
curvesLeg = as.factor(rep(c("+/- 0.5 SD", "+/- 1 SD", "+/- 1.5 SD", "Conditional", "+/- 0.5 SD", "+/- 1 SD", "+/- 1.5 SD"), each = length(time))) 
)

# calculate marginal mean activity curve
p_df2 <- p_df %>% select(p, time) %>% group_by(time) %>% 
  summarize(p = mean(p)) %>% 
  mutate(mean = "on", curvesID = as.factor(8),
         curvesLeg = as.factor("Marginal"))

p_df <- rbind(p_df, as.data.frame(p_df2))

pl_hor <- ggplot(p_df, aes(x = time, y = p, group = curvesID)) +
  geom_line(aes(color = curvesLeg, size = mean, linetype = mean)) +
  scale_color_manual(values = c("grey40", "grey60", "grey80", "red", "black")) +
  scale_size_manual(values = c(0.5, 1.5)) +
  scale_linetype_manual(values = c(2, 1)) +
  #coord_cartesian(ylim = c(0.006, 0.055)) +
  #geom_path(data = data.frame(x = c(11.5, 9), y = c(0.005, 0.005)), aes(x = x, y = y), linejoin = "mitre") +
  labs(x = "Time of Day", y = "Activity Patterns", title = "B) Variability in time of activity peak") +
  theme_minimal()+
  theme(legend.position = "none", 
        axis.line = element_line(colour = 'black', linetype = 'solid'),
        axis.ticks.x = element_line(colour = 'black', linetype = 'solid'),# element_blank(), 
        axis.text.y = element_blank(), #element_text(size=8),
        axis.title=element_text(size=10,face="bold"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) +
  geom_segment(aes(x=12 - 0.75, y=max(p) + 0.02, xend=12 - 7, yend=max(p) + 0.02), arrow=arrow(length= unit(0.5, "cm")), 
               size = 1, color = "orange", linejoin = "mitre") +
  geom_segment(aes(x=12 + 0.75, y=max(p) + 0.02, xend=12 + 7, yend=max(p) + 0.02), arrow=arrow(length= unit(0.5, "cm")), 
               size = 1, color = "orange", linejoin = "mitre") +
  scale_x_continuous(breaks=seq(0,24,length.out=7), labels=seq(0,24,4))+
  guides(linetype=element_blank())
pl_hor

#' Join plots
pl <- grid.arrange(pl_vert, pl_hor, ncol = 2)
# ggsave(pl, filename = "figures/Fig1_Site_Variability_in_Activity_bimodal.jpg", device = "jpeg", units = "cm", width = 16, height = 8, dpi = 300)

```
The dashed lines in panel B represent curves simulated using different values of $\gamma_i$ (darker to lighter colors from lower to higher in absolute values). Varying the random phaseshift $\gamma_i$ results in activity curves that are shifted horizontally. Because we are simulating data using two cosine terms, the cumulative effects of the two random phaseshifts (one per cosine term) also affect the intensity of site-use. Again, we will discuss in more details when illustrating the differences between conditional and marginal mean activity curves. 

For completeness, we present also the example of a unimodal pattern. We can simulate this activity pattern setting $\beta_2 = 0$ (see main text) and re-running the code above. Setting $\beta_2 = 0$ eliminates the second cosine term and returns a curve with only one peak in activity within the 24-hour cycle.

```{r sim4}
# setting beta2 equal to zero 
b2 = 0

# change in frequency of site-use
# creating the curves
p_df <- data.frame(p = c(
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[1]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[2]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[3]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[5]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[6]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+theta0 + gamma_i[4]) + tau_i[7])
), time = rep(time, 7), 
mean = c(rep(rep("off", length(time)),3), rep("on", length(time)), rep(rep("off", length(time)),3)),
curvesID = as.factor(rep(1:7, each = length(time))),
curvesLeg = as.factor(rep(c("+/- 1.5 SD", "+/- 1 SD", "+/- 0.5 SD", "Conditional", "+/- 0.5 SD", "+/- 1 SD", "+/- 1.5 SD"), each = length(time)))
)

# calculate marginal mean activity curve
p_df2 <- p_df %>% select(p, time) %>% group_by(time) %>% 
  summarize(p = mean(p)) %>% 
  mutate(mean = "on", curvesID = as.factor(8),
         curvesLeg = as.factor("Marginal"))

p_df <- rbind(p_df, as.data.frame(p_df2))

pl_vert_uni <- ggplot(p_df, aes(x = time, y = p, group = curvesID)) +
  geom_line(aes(color = curvesLeg, size = mean, linetype = mean)) +
  scale_color_manual(values = c("grey40", "grey60", "grey80", "red", "black")) +
  scale_size_manual(values = c(0.5, 1.5)) +
  scale_linetype_manual(values = c(2, 1, 2)) +
  coord_cartesian(ylim = c(-0.05, max(p_df$p)+0.053)) +
  #geom_path(data = data.frame(x = c(11.5, 9), y = c(0.005, 0.005)), aes(x = x, y = y), linejoin = "mitre") +
  labs(x = "Time of Day", y = "Activity Patterns", title = "A) Variability in frequency of site-use") +
  theme_minimal()+
  theme(legend.position = "none",
        axis.line = element_line(colour = 'black', linetype = 'solid'),
        axis.ticks.x = element_line(colour = 'black', linetype = 'solid'), #element_blank(), #
        axis.text.y = element_blank(), #element_text(size=8),
        axis.title=element_text(size=10,face="bold"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) + 
  geom_segment(aes(x=12, y=min(p), xend=12, yend=min(p)-0.05), arrow=arrow(length= unit(0.5, "cm")), 
               size = 1, color = "orange", linejoin = "mitre") +
  geom_segment(aes(x=12, y=max(p)+0.003, xend=12, yend=max(p)+0.053), arrow=arrow(length= unit(0.5, "cm")), 
               size = 1, color = "orange", linejoin = "mitre")+
  scale_x_continuous(breaks=seq(0,24,length.out=7), labels=seq(0,24,4)) 


# creating the curves
p_df <- data.frame(p = c(
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[1]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[1]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[2]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[2]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[3]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[3]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[4]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[4]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[5]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[5]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[6]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[6]) + tau_i[4]),
  boot::inv.logit(b0 + b1*cos(2*pi*time/(24)+theta0 + gamma_i[7]) + b2*cos(2*pi*time/(12)+ theta1 + gamma_i[7]) + tau_i[4])
), time = rep(time, 7), 
mean = c(rep(rep("off", length(time)),3), rep("on", length(time)), rep(rep("off", length(time)),3)),
curvesID = as.factor(rep(1:7, each = length(time))),
curvesLeg = as.factor(rep(c("+/- 0.5 SD", "+/- 1 SD", "+/- 1.5 SD", "Conditional", "+/- 0.5 SD", "+/- 1 SD", "+/- 1.5 SD"), each = length(time))) 
)

# calculate marginal mean activity curve
p_df2 <- p_df %>% select(p, time) %>% group_by(time) %>% 
  summarize(p = mean(p)) %>% 
  mutate(mean = "on", curvesID = as.factor(8),
         curvesLeg = as.factor("Marginal"))

p_df <- rbind(p_df, as.data.frame(p_df2))

pl_hor_uni <- ggplot(p_df, aes(x = time, y = p, group = curvesID)) +
  geom_line(aes(color = curvesLeg, size = mean, linetype = mean)) +
  scale_color_manual(values = c("grey40", "grey60", "grey80", "red", "black")) +
  scale_size_manual(values = c(0.5, 1.5)) +
  scale_linetype_manual(values = c(2, 1)) +
  #coord_cartesian(ylim = c(0.006, 0.055)) +
  #geom_path(data = data.frame(x = c(11.5, 9), y = c(0.005, 0.005)), aes(x = x, y = y), linejoin = "mitre") +
  labs(x = "Time of Day", y = "Activity Patterns", title = "B) Variability in time of activity peak") +
  theme_minimal()+
  theme(legend.position = "none", 
        axis.line = element_line(colour = 'black', linetype = 'solid'),
        axis.ticks.x = element_line(colour = 'black', linetype = 'solid'),# element_blank(), 
        axis.text.y = element_blank(), #element_text(size=8),
        axis.title=element_text(size=10,face="bold"),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank()) +
  geom_segment(aes(x=13.5 - 0.75, y=max(p) + 0.02, xend=13.5 - 7, yend=max(p) + 0.02), arrow=arrow(length= unit(0.5, "cm")), 
               size = 1, color = "orange", linejoin = "mitre") +
  geom_segment(aes(x=13.5 + 0.75, y=max(p) + 0.02, xend=13.5 + 7, yend=max(p) + 0.02), arrow=arrow(length= unit(0.5, "cm")), 
               size = 1, color = "orange", linejoin = "mitre") +
  scale_x_continuous(breaks=seq(0,24,length.out=7), labels=seq(0,24,4))+
  guides(linetype=element_blank())


#' Join plots
pl <- grid.arrange(pl_vert_uni, pl_hor_uni, ncol = 2)
```
This second example clearly illustrate how varying $\gamma_i$ (while keeping all the other parameters constant) leads to the horizontal shift of the curves, with peaks in activity equal across time but occurring at different times of the diel cycle.

In the next section, we will use data created with this simulation approach to illustrate how
trigonometric and cyclic cubic regression spline GLMMs can be used to estimate activity patterns. In section 
\@ref(condvsmarg), we will illustrate the difference between conditional and marginal mean
activity patterns and explained how this difference can be relevant when answering ecological 
questions.



